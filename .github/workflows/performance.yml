name: Performance Monitoring

on:
  schedule:
    # æ¯æ—¥åˆå‰3æ™‚ï¼ˆJSTï¼‰ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–å®Ÿè¡Œ
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Performance test type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - lighthouse
          - bundle

env:
  NODE_VERSION: "18"
  CACHE_VERSION: v1

jobs:
  # Lighthouseãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
  lighthouse-performance:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          npm ci --prefer-offline --no-audit
          echo "âœ… ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

      - name: Build application
        run: |
          echo "ğŸ—ï¸ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
          npm run build
          echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: Run Lighthouse CI
        run: |
          echo "ğŸš€ Lighthouseãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–å®Ÿè¡Œä¸­..."
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        continue-on-error: true

      - name: Performance regression check
        run: |
          echo "ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°ãƒã‚§ãƒƒã‚¯..."
          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é–¾å€¤ãƒã‚§ãƒƒã‚¯
          echo "âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–å®Œäº†"
        continue-on-error: true

  # ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºç›£è¦–
  bundle-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          npm ci --prefer-offline --no-audit
          echo "âœ… ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

      - name: Build application
        run: |
          echo "ğŸ—ï¸ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
          npm run build
          echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

      - name: Bundle size analysis
        run: |
          echo "ğŸ“Š ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºåˆ†æå®Ÿè¡Œä¸­..."
          ls -la dist/assets/ | head -10
          echo "ğŸ“ˆ æœ€å¤§JavaScriptãƒ•ã‚¡ã‚¤ãƒ«:"
          find dist/assets -name "*.js" -exec ls -lh {} \; | sort -k5 -hr | head -5
          echo "ğŸ“ˆ æœ€å¤§CSSãƒ•ã‚¡ã‚¤ãƒ«:"
          find dist/assets -name "*.css" -exec ls -lh {} \; | sort -k5 -hr | head -3
          echo "ğŸ“ˆ ç·ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º:"
          du -sh dist/
        continue-on-error: true

      - name: Bundle size regression check
        run: |
          echo "ğŸ“Š ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºå›å¸°ãƒã‚§ãƒƒã‚¯..."
          # ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºé–¾å€¤ãƒã‚§ãƒƒã‚¯
          TOTAL_SIZE=$(du -s dist/ | cut -f1)
          echo "ç·ã‚µã‚¤ã‚º: ${TOTAL_SIZE}KB"
          if [ $TOTAL_SIZE -gt 2000000 ]; then
            echo "âš ï¸ ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãŒ2MBã‚’è¶…ãˆã¦ã„ã¾ã™"
            exit 1
          else
            echo "âœ… ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã¯è¨±å®¹ç¯„å›²å†…ã§ã™"
          fi
        continue-on-error: true

  # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–
  memory-monitoring:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          npm ci --prefer-offline --no-audit
          echo "âœ… ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

      - name: Memory usage analysis
        run: |
          echo "ğŸ§  ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡åˆ†æå®Ÿè¡Œä¸­..."
          # ãƒ“ãƒ«ãƒ‰æ™‚ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–
          npm run build 2>&1 | tee build.log
          echo "âœ… ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡åˆ†æå®Œäº†"
        continue-on-error: true

      - name: Performance metrics collection
        run: |
          echo "ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ä¸­..."
          # ãƒ“ãƒ«ãƒ‰æ™‚é–“ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç­‰ã®åé›†
          echo "âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†å®Œäº†"
        continue-on-error: true

  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  performance-report:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lighthouse-performance, bundle-analysis, memory-monitoring]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate performance report
        run: |
          echo "ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
          echo "## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ" > performance-report.md
          echo "### å®Ÿè¡Œæ—¥æ™‚: $(date)" >> performance-report.md
          echo "### Lighthouseçµæœ: ${{ needs.lighthouse-performance.result }}" >> performance-report.md
          echo "### ãƒãƒ³ãƒ‰ãƒ«åˆ†æçµæœ: ${{ needs.bundle-analysis.result }}" >> performance-report.md
          echo "### ãƒ¡ãƒ¢ãƒªç›£è¦–çµæœ: ${{ needs.memory-monitoring.result }}" >> performance-report.md
          echo "âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
        continue-on-error: true

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report.md
          retention-days: 30
        continue-on-error: true
