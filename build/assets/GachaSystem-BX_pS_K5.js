import{r as h,j as e}from"./ui-iDNYoGPn.js";import{B as f,C as S,f as B,h as L,d as X,e as $,u as z,b as _}from"./game-DNOgwd-m.js";import{t as D,g as T}from"./toeicGachaCards-DfJpPr8Q.js";import{D as F}from"./progress-BvHZoEqe.js";import{q as E,M as V,N as q,O as W,P as J,Q as H,I as Y,U as Z,V as Q,g as R,A as K,W as M,Z as U,S as ee,X as ae,s as se}from"./learning-13Go7wUu.js";import{G as te}from"./gacha-card-BjHXGPaw.js";import"./vendor-D3F3s8fL.js";const k={rare:.15,epic:.04,legendary:.01};let g=class{static drawRandomCard(){const s=Math.random();let a;s<k.legendary?a="legendary":s<k.legendary+k.epic?a="epic":s<k.legendary+k.epic+k.rare?a="rare":s<.8?a="uncommon":a="common",console.log(`GachaSystem.drawRandomCard - Rolled ${s}, selected rarity: ${a}`);const r=D.filter(l=>l.rarity===a);if(console.log(`GachaSystem.drawRandomCard - Available ${a} cards:`,r.length),r.length===0){console.warn(`GachaSystem.drawRandomCard - No ${a} cards available, falling back to common`);const l=D.filter(n=>n.rarity==="common");return console.log("GachaSystem.drawRandomCard - Common cards available:",l.length),l[Math.floor(Math.random()*l.length)]}return r[Math.floor(Math.random()*r.length)]}static openPack(s){try{console.log("GachaSystem.openPack - Opening pack:",s);const a=T.find(n=>n.id===s);if(!a)throw new Error(`Pack with id ${s} not found`);console.log("GachaSystem.openPack - Pack found:",a.name,"theme:",a.theme);const r=[],l=new Set;for(let n=0;n<8;n++){let o,x=0;const d=100;do{if(o=this.drawRandomCard(),x++,a.theme!=="mixed"){const v=D.filter(w=>w.toeicSpecific.parts.some(u=>a.theme==="part1_2"?["Part1","Part2"].includes(u):a.theme==="part3_4"?["Part3","Part4"].includes(u):a.theme==="part5_6"?["Part5","Part6"].includes(u):a.theme==="part7"?u==="Part7":!0));v.length>0&&(o=v[Math.floor(Math.random()*v.length)])}if(x>=d)break}while(l.has(o.id));r.push(o),l.add(o.id),console.log(`GachaSystem.openPack - Drew card ${n+1}:`,o.word,o.rarity)}return console.log("GachaSystem.openPack - Final cards:",r.length),r}catch(a){throw console.error("GachaSystem.openPack - Error:",a),a}}static getUserGachaData(){const s=localStorage.getItem("userGachaData");return s?JSON.parse(s):{ownedCards:[],totalPacks:0,dailyPacksUsed:0,lastPackDate:"",availablePacks:2,lastPackOpenTime:0,collection:{totalCards:0,uniqueCards:0,rarityStats:{}}}}static saveUserGachaData(s){localStorage.setItem("userGachaData",JSON.stringify(s))}static addCardsToCollection(s){const a=this.getUserGachaData(),r=this.updateAvailablePacksCount(a);s.forEach(n=>{r.ownedCards.push(n)}),r.collection.totalCards=r.ownedCards.length;const l=new Set(r.ownedCards.map(n=>n.id));r.collection.uniqueCards=l.size,r.collection.rarityStats={},r.ownedCards.forEach(n=>{r.collection.rarityStats[n.rarity]=(r.collection.rarityStats[n.rarity]||0)+1}),this.saveUserGachaData(r)}static openPackAndSave(s){try{console.log("GachaSystem.openPackAndSave - Starting pack opening:",s);const a=this.openPack(s);console.log("GachaSystem.openPackAndSave - Cards drawn:",a.length),this.addCardsToCollection(a),console.log("GachaSystem.openPackAndSave - Cards added to collection");const r=this.getUserGachaData();return r.totalPacks++,r.lastPackOpenTime=Date.now(),r.availablePacks=Math.max(0,(r.availablePacks||2)-1),this.saveUserGachaData(r),console.log("GachaSystem.openPackAndSave - User data updated"),a}catch(a){throw console.error("GachaSystem.openPackAndSave - Error:",a),a}}static getAvailablePacks(){return T}static getPackById(s){return T.find(a=>a.id===s)}static canOpenPack(s,a){const r=this.getPackById(s);if(!r)return{canOpen:!1,reason:"パックが見つかりません"};if(a<r.cost)return{canOpen:!1,reason:`XPが不足しています (必要: ${r.cost}, 現在: ${a})`};const l=this.getUserGachaData();return this.getAvailablePacksCount(l)<=0?{canOpen:!1,reason:"利用可能なパックがありません",nextPackTime:this.getNextPackRecoveryTime(l)}:{canOpen:!0}}static getAvailablePacksCount(s){const a=Date.now(),r=s.lastPackOpenTime||0,l=s.availablePacks||2,n=300*1e3;if(l>=2)return 2;const o=a-r,x=Math.floor(o/n);return Math.min(2,l+x)}static getNextPackRecoveryTime(s){const a=Date.now(),r=s.lastPackOpenTime||a,l=300*1e3;return r+l}static updateAvailablePacksCount(s){const a=this.getAvailablePacksCount(s);return{...s,availablePacks:a}}static addToVocabularySystem(s){try{F.addGachaWordsToVocabulary(s),console.log("Added gacha cards to vocabulary system:",s)}catch(a){console.error("Error adding gacha cards to vocabulary system:",a)}}};function re({cards:b,onCardClick:s,title:a="カードコレクション",showFilters:r=!0,showSearch:l=!0,className:n}){const[o,x]=h.useState(""),[d,v]=h.useState("name"),[w,u]=h.useState("asc"),[j,O]=h.useState("all"),[N,G]=h.useState("grid"),[t,m]=h.useState("2"),p={common:1,uncommon:2,rare:3,epic:4,legendary:5},i=b.filter(c=>{const y=c.word.toLowerCase().includes(o.toLowerCase())||c.meaning.toLowerCase().includes(o.toLowerCase()),P=j==="all"||c.rarity===j;return y&&P}).sort((c,y)=>{let P=0;switch(d){case"name":P=c.word.localeCompare(y.word);break;case"rarity":P=p[c.rarity]-p[y.rarity];break;case"recent":P=c.id-y.id;break}return w==="asc"?P:-P}),C=b.reduce((c,y)=>(c[y.rarity]=(c[y.rarity]||0)+1,c),{}),A={common:"コモン",uncommon:"アンコモン",rare:"レア",epic:"エピック",legendary:"レジェンダリー"},I={common:"bg-gray-100 text-gray-700 border-gray-300",uncommon:"bg-green-100 text-green-700 border-green-300",rare:"bg-blue-100 text-blue-700 border-blue-300",epic:"bg-purple-100 text-purple-700 border-purple-300",legendary:"bg-yellow-100 text-yellow-700 border-yellow-300"};return e.jsxs("div",{className:E("space-y-6",n),children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:a}),e.jsxs("p",{className:"text-gray-600",children:[i.length," / ",b.length," カード"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"flex items-center gap-1 border rounded-md p-1",children:[e.jsx(f,{variant:N==="grid"&&t==="2"?"default":"ghost",size:"sm",onClick:()=>{G("grid"),m("2")},className:"h-8 w-8 p-1",children:e.jsx(V,{className:"w-4 h-4"})}),e.jsx(f,{variant:N==="grid"&&t==="3"?"default":"ghost",size:"sm",onClick:()=>{G("grid"),m("3")},className:"h-8 w-8 p-1",children:e.jsx(q,{className:"w-4 h-4"})}),e.jsx(f,{variant:N==="list"?"default":"ghost",size:"sm",onClick:()=>G("list"),className:"h-8 w-8 p-1",children:e.jsx(W,{className:"w-4 h-4"})})]})})]}),r&&e.jsxs(S,{children:[e.jsx(B,{children:e.jsxs(L,{className:"text-lg flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5"}),"フィルター・ソート"]})}),e.jsxs(X,{className:"space-y-4",children:[l&&e.jsxs("div",{className:"relative",children:[e.jsx(H,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(Y,{placeholder:"カード名や意味で検索...",value:o,onChange:c=>x(c.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs($,{variant:j==="all"?"default":"outline",className:"cursor-pointer",onClick:()=>O("all"),children:["全て (",b.length,")"]}),Object.entries(C).map(([c,y])=>e.jsxs($,{variant:j===c?"default":"outline",className:E("cursor-pointer",j===c?"":I[c]),onClick:()=>O(c),children:[A[c]," (",y,")"]},c))]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:d,onChange:c=>v(c.target.value),className:"px-3 py-1 border border-gray-300 rounded-md text-sm",children:[e.jsx("option",{value:"name",children:"名前順"}),e.jsx("option",{value:"rarity",children:"レアリティ順"}),e.jsx("option",{value:"recent",children:"取得順"})]}),e.jsx(f,{variant:"outline",size:"sm",onClick:()=>u(w==="asc"?"desc":"asc"),children:w==="asc"?e.jsx(Z,{className:"w-4 h-4"}):e.jsx(Q,{className:"w-4 h-4"})})]})]})]})]}),i.length===0?e.jsx(S,{className:"p-8 text-center",children:e.jsx("p",{className:"text-gray-500",children:"該当するカードが見つかりませんでした"})}):e.jsx("div",{className:E("grid gap-2",N==="grid"?t==="2"?"grid-cols-2":"grid-cols-3":"grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"),children:i.map((c,y)=>e.jsx(te,{card:c,onClick:()=>s?.(c),size:N==="grid"&&t==="3"?"sm":"md",showDetails:N==="list",isAnimated:!0,isFavorite:!1,onFavoriteToggle:()=>{console.log(`Toggle favorite for card: ${c.word}`)},className:"hover:z-10"},`${c.id}-${y}`))})]})}const ne=({onBack:b,userXP:s,onXPChange:a})=>{const r=z();_();const[l,n]=h.useState(!1),[o,x]=h.useState(null),[d,v]=h.useState(g.getUserGachaData()),[w]=h.useState(g.getAvailablePacks()),[u,j]=h.useState(!1);h.useEffect(()=>{const t=()=>{const p=g.updateAvailablePacksCount(d);v(p)};t();const m=setInterval(t,3e4);return()=>clearInterval(m)},[]);const O=async t=>{const m=g.getPackById(t);if(!m)return;const p=g.canOpenPack(t,s);if(!p.canOpen){alert(p.reason);return}n(!0),x(t),await new Promise(i=>setTimeout(i,2e3));try{console.log("Opening pack:",t,"with userXP:",s);const i=g.openPackAndSave(t);console.log("Cards drawn:",i);const C=s-m.cost;console.log("Updating XP from",s,"to",C),a(C),console.log("Adding cards to vocabulary system..."),g.addToVocabularySystem(i),console.log("Updating user gacha data..."),v(g.getUserGachaData()),console.log("Pack opening completed successfully"),n(!1),x(null);const A=encodeURIComponent(JSON.stringify(i));r(`/games/gacha/result?cards=${A}&packName=${encodeURIComponent(m.name)}`)}catch(i){console.error("Error opening pack:",i),alert("ガチャの開封中にエラーが発生しました: "+(i instanceof Error?i.message:"不明なエラー")),console.error("Error details:",{packId:t,userXP:s,packCost:m.cost,error:i instanceof Error?i.message:String(i)}),alert(`パックの開封中にエラーが発生しました: ${i instanceof Error?i.message:String(i)}`),n(!1),x(null)}},N=t=>{switch(t){case"part1_2":return"🎧";case"part3_4":return"💬";case"part5_6":return"📝";case"part7":return"📖";case"mixed":return"🎯";default:return"📦"}},G=t=>{switch(t){case"400-500":return"bg-green-100 text-green-800";case"500-600":return"bg-blue-100 text-blue-800";case"600-700":return"bg-purple-100 text-purple-800";case"700-800":return"bg-orange-100 text-orange-800";case"800+":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}};return e.jsxs("div",{className:"max-w-6xl mx-auto p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(f,{variant:"outline",size:"sm",onClick:()=>r("/"),className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-4 h-4"}),"戻る"]}),e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(M,{className:"w-8 h-8 text-purple-600"}),"TOEIC単語ガチャ"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(f,{variant:"outline",size:"sm",onClick:()=>j(!u),className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4"}),u?"パック選択":"コレクション"]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"所持XP"}),e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:s})]})]})]}),e.jsxs(S,{className:"p-4 mb-6",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"コレクション統計"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-600",children:"総カード数"}),e.jsx("div",{className:"font-bold",children:d.collection.totalCards})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-600",children:"ユニークカード"}),e.jsx("div",{className:"font-bold",children:d.collection.uniqueCards})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-600",children:"開封パック数"}),e.jsx("div",{className:"font-bold",children:d.totalPacks})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-600",children:"利用可能パック"}),e.jsxs("div",{className:"font-bold",children:[g.getAvailablePacksCount(d),"/2"]})]})]})]}),g.getAvailablePacksCount(d)<2&&e.jsx(S,{className:"mb-6",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-2 flex items-center gap-2",children:[e.jsx(U,{className:"w-5 h-5 text-yellow-500"}),"パック回復システム"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"次のパック回復まで"}),e.jsx("span",{className:"font-bold text-purple-600",children:(()=>{const t=g.getNextPackRecoveryTime(d),m=Math.max(0,t-Date.now());return`${Math.ceil(m/(1e3*60))}分`})()})]}),e.jsx("div",{className:"text-sm text-gray-500",children:"💡 5分ごとに1パック回復します（最大2パック）"}),e.jsx(f,{variant:"outline",size:"sm",onClick:()=>{localStorage.removeItem("userGachaData"),v(g.getUserGachaData())},className:"mt-2 text-xs",children:"🔄 テスト用リセット"})]})]})}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:u?"所持カードコレクション":"パックを選択"}),u?e.jsx("div",{children:d.ownedCards.length===0?e.jsxs(S,{className:"text-center py-12",children:[e.jsx(M,{className:"w-16 h-16 mx-auto text-gray-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"まだカードを所持していません"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"パックを開封してカードを集めよう！"}),e.jsx(f,{onClick:()=>j(!1),className:"bg-purple-600 hover:bg-purple-700",children:"パックを開封する"})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-6 mb-4 p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-purple-600",children:d.ownedCards.length}),e.jsx("div",{className:"text-xs text-gray-600",children:"総カード数"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-blue-600",children:d.collection.uniqueCards}),e.jsx("div",{className:"text-xs text-gray-600",children:"ユニークカード"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-green-600",children:d.ownedCards.filter(t=>t.rarity==="rare"||t.rarity==="epic"||t.rarity==="legendary").length}),e.jsx("div",{className:"text-xs text-gray-600",children:"レア以上"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-yellow-600",children:d.ownedCards.filter(t=>t.rarity==="legendary").length}),e.jsx("div",{className:"text-xs text-gray-600",children:"レジェンダリー"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[e.jsx(f,{variant:"outline",size:"sm",onClick:()=>j(!u),className:"text-xs",children:"全て"}),[{rarity:"common",name:"コモン",color:"text-gray-700 border-gray-400"},{rarity:"uncommon",name:"アンコモン",color:"text-green-700 border-green-500"},{rarity:"rare",name:"レア",color:"text-blue-700 border-blue-500"},{rarity:"epic",name:"エピック",color:"text-purple-700 border-purple-500"},{rarity:"legendary",name:"レジェンダリー",color:"text-yellow-700 border-yellow-500"}].map(({rarity:t,name:m,color:p})=>{const i=d.ownedCards.filter(C=>C.rarity===t).length;return e.jsxs(f,{variant:"outline",size:"sm",className:`text-xs ${p} border-2`,children:[m," (",i,")"]},t)})]}),e.jsx(re,{cards:d.ownedCards,onCardClick:t=>{setSelectedCard(t),setShowCardDetail(!0)},title:"マイコレクション",showFilters:!0,showSearch:!0})]})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:w.map(t=>{const m=g.canOpenPack(t.id,s),p=t.rarity==="normal"?ee:t.rarity==="premium"?U:ae;return e.jsxs(S,{className:`p-4 transition-all hover:shadow-lg cursor-pointer ${o===t.id?"ring-2 ring-purple-500":""} ${m.canOpen?"":"opacity-60 cursor-not-allowed"}`,onClick:()=>m.canOpen&&!l&&O(t.id),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:N(t.theme)}),e.jsx(p,{className:"w-5 h-5 text-purple-600"})]}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${G(t.targetScore)}`,children:t.targetScore})]}),e.jsx("h3",{className:"font-bold text-lg mb-1",children:t.name}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:t.description}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-lg font-bold text-purple-600",children:[t.cost," XP"]}),e.jsx("div",{className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${m.canOpen&&!l?"bg-purple-600 text-white hover:bg-purple-700":"bg-gray-300 text-gray-500"}`,children:l&&o===t.id?"開封中...":m.canOpen?"クリックして開封":"開封不可"})]}),!m.canOpen&&e.jsxs("div",{className:"text-xs text-red-600 mt-2",children:[m.reason,m.nextPackTime&&e.jsxs("div",{className:"mt-1 text-gray-500",children:["次の回復:"," ",(()=>{const i=Math.max(0,m.nextPackTime-Date.now());return`${Math.ceil(i/(1e3*60))}分後`})()]})]})]},t.id)})})]}),l&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg text-center",children:[e.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"パックを開封中..."}),e.jsx("p",{className:"text-gray-600",children:"素晴らしいカードが待っています！"})]})})]})};function ge(){const b=z(),[s,a]=h.useState(1e3);h.useEffect(()=>{try{const o=R().getXP();console.log("Initial XP loaded:",o),a(o||1e3)}catch(n){console.error("Error getting initial XP:",n),a(1e3)}},[]);const r=n=>{console.log("handleXPChange called with:",n),a(n);try{const o=R(),x=o.getXP();console.log("Current XP in manager:",x,"Setting to:",n);const d=n-x;d!==0&&o.addXP(d),se(),console.log("XP updated successfully")}catch(o){console.error("Error updating XP:",o)}},l=()=>{b("/")};return e.jsx(ne,{onBack:l,userXP:s,onXPChange:r})}export{ne as GachaSystemComponent,ge as default};
