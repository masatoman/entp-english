import{r as c,j as e}from"./ui-smpf69Zd.js";import{B as g,C,f as B,h as L,d as X,e as $,u as E,b as M}from"./game-Dd6Kb0LE.js";import{c as T,J as I,K as R,M as F,N as V,O as _,I as q,P as J,Q as W,g as A,G as o,A as Z,U as D,Z as z,S as H,V as K,s as Q}from"./learning-B-E1ZIuS.js";import{G as Y}from"./gacha-card-BWKZwBAB.js";import"./vendor-D3F3s8fL.js";import"./progress-BPWR83xl.js";function ee({cards:N,onCardClick:x,title:v="カードコレクション",showFilters:w=!0,showSearch:u=!0,className:i}){const[n,p]=c.useState(""),[l,S]=c.useState("name"),[P,f]=c.useState("asc"),[h,O]=c.useState("all"),[j,k]=c.useState("grid"),[s,r]=c.useState("2"),d={common:1,uncommon:2,rare:3,epic:4,legendary:5},t=N.filter(a=>{const m=a.word.toLowerCase().includes(n.toLowerCase())||a.meaning.toLowerCase().includes(n.toLowerCase()),b=h==="all"||a.rarity===h;return m&&b}).sort((a,m)=>{let b=0;switch(l){case"name":b=a.word.localeCompare(m.word);break;case"rarity":b=d[a.rarity]-d[m.rarity];break;case"recent":b=a.id-m.id;break}return P==="asc"?b:-b}),y=N.reduce((a,m)=>(a[m.rarity]=(a[m.rarity]||0)+1,a),{}),G={common:"コモン",uncommon:"アンコモン",rare:"レア",epic:"エピック",legendary:"レジェンダリー"},U={common:"bg-gray-100 text-gray-700 border-gray-300",uncommon:"bg-green-100 text-green-700 border-green-300",rare:"bg-blue-100 text-blue-700 border-blue-300",epic:"bg-purple-100 text-purple-700 border-purple-300",legendary:"bg-yellow-100 text-yellow-700 border-yellow-300"};return e.jsxs("div",{className:T("space-y-6",i),children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:v}),e.jsxs("p",{className:"text-gray-600",children:[t.length," / ",N.length," カード"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"flex items-center gap-1 border rounded-md p-1",children:[e.jsx(g,{variant:j==="grid"&&s==="2"?"default":"ghost",size:"sm",onClick:()=>{k("grid"),r("2")},className:"h-8 w-8 p-1",children:e.jsx(I,{className:"w-4 h-4"})}),e.jsx(g,{variant:j==="grid"&&s==="3"?"default":"ghost",size:"sm",onClick:()=>{k("grid"),r("3")},className:"h-8 w-8 p-1",children:e.jsx(R,{className:"w-4 h-4"})}),e.jsx(g,{variant:j==="list"?"default":"ghost",size:"sm",onClick:()=>k("list"),className:"h-8 w-8 p-1",children:e.jsx(F,{className:"w-4 h-4"})})]})})]}),w&&e.jsxs(C,{children:[e.jsx(B,{children:e.jsxs(L,{className:"text-lg flex items-center gap-2",children:[e.jsx(V,{className:"w-5 h-5"}),"フィルター・ソート"]})}),e.jsxs(X,{className:"space-y-4",children:[u&&e.jsxs("div",{className:"relative",children:[e.jsx(_,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(q,{placeholder:"カード名や意味で検索...",value:n,onChange:a=>p(a.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs($,{variant:h==="all"?"default":"outline",className:"cursor-pointer",onClick:()=>O("all"),children:["全て (",N.length,")"]}),Object.entries(y).map(([a,m])=>e.jsxs($,{variant:h===a?"default":"outline",className:T("cursor-pointer",h===a?"":U[a]),onClick:()=>O(a),children:[G[a]," (",m,")"]},a))]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:l,onChange:a=>S(a.target.value),className:"px-3 py-1 border border-gray-300 rounded-md text-sm",children:[e.jsx("option",{value:"name",children:"名前順"}),e.jsx("option",{value:"rarity",children:"レアリティ順"}),e.jsx("option",{value:"recent",children:"取得順"})]}),e.jsx(g,{variant:"outline",size:"sm",onClick:()=>f(P==="asc"?"desc":"asc"),children:P==="asc"?e.jsx(J,{className:"w-4 h-4"}):e.jsx(W,{className:"w-4 h-4"})})]})]})]})]}),t.length===0?e.jsx(C,{className:"p-8 text-center",children:e.jsx("p",{className:"text-gray-500",children:"該当するカードが見つかりませんでした"})}):e.jsx("div",{className:T("grid gap-2",j==="grid"?s==="2"?"grid-cols-2":"grid-cols-3":"grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"),children:t.map((a,m)=>e.jsx(Y,{card:a,onClick:()=>x?.(a),size:j==="grid"&&s==="3"?"sm":"md",showDetails:j==="list",isAnimated:!0,isFavorite:!1,onFavoriteToggle:()=>{console.log(`Toggle favorite for card: ${a.word}`)},className:"hover:z-10"},`${a.id}-${m}`))})]})}const se=({onBack:N,userXP:x,onXPChange:v})=>{const w=E();M();const[u,i]=c.useState(!1),[n,p]=c.useState(null),[l,S]=c.useState(o.getUserGachaData()),[P]=c.useState(o.getAvailablePacks()),[f,h]=c.useState(!1);c.useEffect(()=>{const s=()=>{const d=o.updateAvailablePacksCount(l);S(d)};s();const r=setInterval(s,3e4);return()=>clearInterval(r)},[]);const O=async s=>{const r=o.getPackById(s);if(!r)return;const d=o.canOpenPack(s,x);if(!d.canOpen){alert(d.reason);return}i(!0),p(s),await new Promise(t=>setTimeout(t,2e3));try{console.log("Opening pack:",s,"with userXP:",x);const t=o.openPackAndSave(s);console.log("Cards drawn:",t);const y=x-r.cost;console.log("Updating XP from",x,"to",y),v(y),console.log("Adding cards to vocabulary system..."),o.addToVocabularySystem(t),console.log("Updating user gacha data..."),S(o.getUserGachaData()),console.log("Pack opening completed successfully"),i(!1),p(null);const G=encodeURIComponent(JSON.stringify(t));w(`/games/gacha/result?cards=${G}&packName=${encodeURIComponent(r.name)}`)}catch(t){console.error("Error opening pack:",t),alert("ガチャの開封中にエラーが発生しました: "+(t instanceof Error?t.message:"不明なエラー")),console.error("Error details:",{packId:s,userXP:x,packCost:r.cost,error:t instanceof Error?t.message:String(t)}),alert(`パックの開封中にエラーが発生しました: ${t instanceof Error?t.message:String(t)}`),i(!1),p(null)}},j=s=>{switch(s){case"part1_2":return"🎧";case"part3_4":return"💬";case"part5_6":return"📝";case"part7":return"📖";case"mixed":return"🎯";default:return"📦"}},k=s=>{switch(s){case"400-500":return"bg-green-100 text-green-800";case"500-600":return"bg-blue-100 text-blue-800";case"600-700":return"bg-purple-100 text-purple-800";case"700-800":return"bg-orange-100 text-orange-800";case"800+":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}};return e.jsxs("div",{className:"max-w-6xl mx-auto p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>w("/"),className:"flex items-center gap-2",children:[e.jsx(Z,{className:"w-4 h-4"}),"戻る"]}),e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(D,{className:"w-8 h-8 text-purple-600"}),"TOEIC単語ガチャ"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>h(!f),className:"flex items-center gap-2",children:[e.jsx(D,{className:"w-4 h-4"}),f?"パック選択":"コレクション"]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"所持XP"}),e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:x})]})]})]}),e.jsxs(C,{className:"p-4 mb-6",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"コレクション統計"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-600",children:"総カード数"}),e.jsx("div",{className:"font-bold",children:l.collection.totalCards})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-600",children:"ユニークカード"}),e.jsx("div",{className:"font-bold",children:l.collection.uniqueCards})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-600",children:"開封パック数"}),e.jsx("div",{className:"font-bold",children:l.totalPacks})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-600",children:"利用可能パック"}),e.jsxs("div",{className:"font-bold",children:[o.getAvailablePacksCount(l),"/2"]})]})]})]}),o.getAvailablePacksCount(l)<2&&e.jsx(C,{className:"mb-6",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-2 flex items-center gap-2",children:[e.jsx(z,{className:"w-5 h-5 text-yellow-500"}),"パック回復システム"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"次のパック回復まで"}),e.jsx("span",{className:"font-bold text-purple-600",children:(()=>{const s=o.getNextPackRecoveryTime(l),r=Math.max(0,s-Date.now());return`${Math.ceil(r/(1e3*60))}分`})()})]}),e.jsx("div",{className:"text-sm text-gray-500",children:"💡 5分ごとに1パック回復します（最大2パック）"}),e.jsx(g,{variant:"outline",size:"sm",onClick:()=>{localStorage.removeItem("userGachaData"),S(o.getUserGachaData())},className:"mt-2 text-xs",children:"🔄 テスト用リセット"})]})]})}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:f?"所持カードコレクション":"パックを選択"}),f?e.jsx("div",{children:l.ownedCards.length===0?e.jsxs(C,{className:"text-center py-12",children:[e.jsx(D,{className:"w-16 h-16 mx-auto text-gray-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"まだカードを所持していません"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"パックを開封してカードを集めよう！"}),e.jsx(g,{onClick:()=>h(!1),className:"bg-purple-600 hover:bg-purple-700",children:"パックを開封する"})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-6 mb-4 p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-purple-600",children:l.ownedCards.length}),e.jsx("div",{className:"text-xs text-gray-600",children:"総カード数"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-blue-600",children:l.collection.uniqueCards}),e.jsx("div",{className:"text-xs text-gray-600",children:"ユニークカード"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-green-600",children:l.ownedCards.filter(s=>s.rarity==="rare"||s.rarity==="epic"||s.rarity==="legendary").length}),e.jsx("div",{className:"text-xs text-gray-600",children:"レア以上"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-yellow-600",children:l.ownedCards.filter(s=>s.rarity==="legendary").length}),e.jsx("div",{className:"text-xs text-gray-600",children:"レジェンダリー"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[e.jsx(g,{variant:"outline",size:"sm",onClick:()=>h(!f),className:"text-xs",children:"全て"}),[{rarity:"common",name:"コモン",color:"text-gray-700 border-gray-400"},{rarity:"uncommon",name:"アンコモン",color:"text-green-700 border-green-500"},{rarity:"rare",name:"レア",color:"text-blue-700 border-blue-500"},{rarity:"epic",name:"エピック",color:"text-purple-700 border-purple-500"},{rarity:"legendary",name:"レジェンダリー",color:"text-yellow-700 border-yellow-500"}].map(({rarity:s,name:r,color:d})=>{const t=l.ownedCards.filter(y=>y.rarity===s).length;return e.jsxs(g,{variant:"outline",size:"sm",className:`text-xs ${d} border-2`,children:[r," (",t,")"]},s)})]}),e.jsx(ee,{cards:l.ownedCards,onCardClick:s=>{setSelectedCard(s),setShowCardDetail(!0)},title:"マイコレクション",showFilters:!0,showSearch:!0})]})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:P.map(s=>{const r=o.canOpenPack(s.id,x),d=s.rarity==="normal"?H:s.rarity==="premium"?z:K;return e.jsxs(C,{className:`p-4 transition-all hover:shadow-lg cursor-pointer ${n===s.id?"ring-2 ring-purple-500":""} ${r.canOpen?"":"opacity-60 cursor-not-allowed"}`,onClick:()=>r.canOpen&&!u&&O(s.id),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:j(s.theme)}),e.jsx(d,{className:"w-5 h-5 text-purple-600"})]}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${k(s.targetScore)}`,children:s.targetScore})]}),e.jsx("h3",{className:"font-bold text-lg mb-1",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:s.description}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-lg font-bold text-purple-600",children:[s.cost," XP"]}),e.jsx("div",{className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${r.canOpen&&!u?"bg-purple-600 text-white hover:bg-purple-700":"bg-gray-300 text-gray-500"}`,children:u&&n===s.id?"開封中...":r.canOpen?"クリックして開封":"開封不可"})]}),!r.canOpen&&e.jsxs("div",{className:"text-xs text-red-600 mt-2",children:[r.reason,r.nextPackTime&&e.jsxs("div",{className:"mt-1 text-gray-500",children:["次の回復:"," ",(()=>{const t=Math.max(0,r.nextPackTime-Date.now());return`${Math.ceil(t/(1e3*60))}分後`})()]})]})]},s.id)})})]}),u&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg text-center",children:[e.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"パックを開封中..."}),e.jsx("p",{className:"text-gray-600",children:"素晴らしいカードが待っています！"})]})})]})};function ie(){const N=E(),[x,v]=c.useState(1e3);c.useEffect(()=>{try{const n=A().getXP();console.log("Initial XP loaded:",n),v(n||1e3)}catch(i){console.error("Error getting initial XP:",i),v(1e3)}},[]);const w=i=>{console.log("handleXPChange called with:",i),v(i);try{const n=A(),p=n.getXP();console.log("Current XP in manager:",p,"Setting to:",i);const l=i-p;l!==0&&n.addXP(l),Q(),console.log("XP updated successfully")}catch(n){console.error("Error updating XP:",n)}},u=()=>{N("/")};return e.jsx(se,{onBack:u,userXP:x,onXPChange:w})}export{se as GachaSystemComponent,ie as default};
