import{r as n,j as e}from"./ui-C48fKjuK.js";import{k as O,H as M,f as _,A as S,l as W,m as Z,n as F,u as J,o as K,j as P}from"./learning-CJqkZPhv.js";import{C as v,c as R,a as N,B as g,b as V,P as Y}from"./game-DhYA9e1X.js";import{g as ee,Q as se,c as te,s as A}from"./index-NpZQEt4n.js";import{c as ae,f as ne,s as re}from"./questionAdapter-qfrWA0Uz.js";import"./vendor-D3F3s8fL.js";import"./progress-Bh7B1qMw.js";const le="ontouchstart"in window||navigator.maxTouchPoints>0;function ce({blankId:r,droppedWord:l,onDrop:s}){const[{isOver:u},c]=J({accept:"word",drop:x=>s(r,x.word),collect:x=>({isOver:x.isOver()})});return e.jsx("span",{ref:c,className:`
        inline-block min-w-[80px] h-8 px-3 mx-1 border-2 border-dashed rounded-md
        flex items-center justify-center text-center
        ${u?"border-blue-500 bg-blue-50":"border-gray-300"}
        ${l?"bg-blue-100 border-blue-400 border-solid":""}
        transition-all duration-200
      `,children:l||"?"})}function ie({word:r}){const[{isDragging:l},s]=K({type:"word",item:{word:r},collect:u=>({isDragging:u.isDragging()})});return e.jsx("span",{ref:s,className:`
        inline-block px-3 py-1 mx-1 mb-2 bg-blue-100 text-blue-800 rounded-md cursor-move
        hover:bg-blue-200 transition-colors duration-200
        ${l?"opacity-50":""}
      `,children:r})}function pe({onBack:r,difficulty:l="intermediate"}){const[s,u]=n.useState([]),[c,x]=n.useState(0),[Q,C]=n.useState({}),[b,k]=n.useState(0),[T,D]=n.useState(!1),[oe,L]=n.useState(0),[i]=n.useState(()=>ee()),[j,q]=n.useState(i.getHeartSystem()),[y,E]=n.useState(i.getLevel()),[$]=n.useState(i.getStatusAllocation());n.useEffect(()=>{if(!i.consumeHeart()){alert("体力が不足しています。回復を待ってから再試行してください。"),r();return}H(),L(Date.now()),q(i.getHeartSystem()),A()},[]);const H=()=>{const t=O(l);if(!t||t.length===0)return console.error("No grammar questions found for difficulty:",l),[];const a=t.map((p,w)=>ae(p,"basic-grammar","normal",y.level)),h=ne(a,y.level),d=[],m=8;for(let p=0;p<m;p++){const w=h.filter(f=>!d.some(G=>G.id===f.id));if(w.length>0){const f=re(w,$);f&&d.push(f)}}u(d)},o=s[c]||null,z=s.length>0?(c+1)/s.length*100:0,U=(t,a)=>{C(h=>({...h,[t]:a}))},I=()=>{c<s.length-1?x(t=>t+1):X()},X=()=>{let t=0;s.forEach(d=>{let m=!0;d.correctAnswer&&(m=Math.random()>.3),m&&t++}),k(t),D(!0);const a=te(s.length>0?s.map((d,m)=>({questionId:d.id,answer:Q[`blank_${m}`]||"",isCorrect:Math.random()>.3})):[],o?.rank||"normal",!0),h=i.addXP(a);E(i.getLevel()),A(),h.leveledUp?P.playLevelUpSound():P.playCompletionSound()},B=()=>{x(0),C({}),k(0),D(!1),H(),L(Date.now())};return T?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs(v,{className:"mb-6",children:[e.jsx(R,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"クイズ結果"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(M,{className:"w-5 h-5 text-red-500"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[j.current,"/",j.max]})]})]})}),e.jsx(N,{children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsxs("div",{className:"text-4xl font-bold text-blue-600",children:[b," / ",s.length]}),e.jsxs("div",{className:"text-lg text-gray-600",children:["正解率: ",Math.round(b/s.length*100),"%"]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["獲得XP: ",s.reduce((t,a)=>t+a.xpReward,0)]}),e.jsxs("div",{className:"flex justify-center space-x-4",children:[e.jsxs(g,{onClick:B,className:"flex items-center",children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"もう一度挑戦"]}),e.jsxs(g,{onClick:r,variant:"outline",className:"flex items-center",children:[e.jsx(S,{className:"w-4 h-4 mr-2"}),"ホームに戻る"]})]})]})})]})})}):!o||s.length===0?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsx(v,{children:e.jsxs(N,{className:"p-8 text-center",children:[e.jsx("div",{className:"text-lg text-gray-600",children:s.length===0?"問題が見つかりませんでした":"問題を読み込み中..."}),e.jsxs(g,{onClick:r,className:"mt-4",children:[e.jsx(S,{className:"w-4 h-4 mr-2"}),"戻る"]})]})})})}):e.jsx(W,{backend:le?Z:F,children:e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs(v,{className:"mb-6",children:[e.jsx(R,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(g,{onClick:r,variant:"outline",size:"sm",children:[e.jsx(S,{className:"w-4 h-4 mr-2"}),"戻る"]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"文法クイズ"})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(M,{className:"w-5 h-5 text-red-500"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[j.current,"/",j.max]})]}),e.jsxs(V,{variant:"secondary",children:["Level ",y.level]})]})]})}),e.jsx(N,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"進捗"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[c+1," / ",s.length]})]}),e.jsx(Y,{value:z,className:"h-2"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm text-gray-600",children:["スコア: ",b," / ",s.length]}),e.jsx(se,{rank:o.rank,showXP:!0,question:o,size:"sm"})]})]})})]}),e.jsx(v,{className:"mb-6",children:e.jsx(N,{className:"p-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-800 mb-2",children:o.question}),e.jsx("p",{className:"text-sm text-gray-600",children:"空欄に適切な単語をドラッグして文を完成させてください"})]}),e.jsx("div",{className:"text-center text-lg",children:o?.options?.map((t,a)=>e.jsxs("span",{children:[a>0&&" ",e.jsx(ce,{blankId:`blank_${a}`,droppedWord:Q[`blank_${a}`]||null,onDrop:U})]},a))||[]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"単語を選んでください"}),e.jsx("div",{className:"flex flex-wrap justify-center gap-2",children:o?.options?.map((t,a)=>e.jsx(ie,{word:t},a))||[]})]})]})})}),e.jsx("div",{className:"flex justify-center",children:e.jsx(g,{onClick:I,size:"lg",children:c<s.length-1?"次の問題":"答え合わせ"})})]})})})}export{pe as EnhancedGrammarQuiz};
